---
layout: post
title:  "redis深入学习(十四)之RDB"
date:   2017-09-18 01:06:05
categories: noSQL
tags: redis
excerpt: redis
---


* conten

### RDB

RDB持久化既可以手动执行,也可以根据服务器配置选项定期执行,该功能可以将某个时间点上的数据库状态保存到一个RDB文件中.

RDB持久化功能生成的RDB文件是一个经过压缩的二进制文件,通过该文件还可以还原成RDB文件时的数据库状态.


### RDB文件的创建与载入

- SAVE:SAVE命令会阻塞Redis服务器进程,直到RDB文件创建完毕为止,在服务器进程阻塞期间,服务器不能处理任何命令请求:


```
redis > SAVE
ok

```

- BGSAVE:命令会派生出一个子进程,然后由子进程负责创建RDB文件,服务器进程(父进程)继续处理命令请求:


```

redis>BGSAVE
Background saving started

```

创建RDB文件的实际工作由rdb.c/rdbSave函数完成,SAVE命令和BGSAVE命令会以不同的方式调用这个函数.

```
def SAVE();


//创建RDB文件
rdbSave();


def BGSAVE(){
	pid =fork();

	if pid ==0;

	//子进程付出创建RDB文件

	rdbSave();

	//完成之后向父进程发送信号
	single_parent()

  elif pid > 0 :

  //父进程继续处理命令请求,并通过轮询等待子进程信号
  handle_request_and_wait_signal()
  else:
  //处理出错情况
  handle_fork_error();
}

```

和使用SAVE命令或者BGSAVE命令创建RDB文件不同,RDB文件的载入工作是在服务器启动时自动执行的,所以Redis并没有专门用于载入RDB文件的命令,只要Redis服务器在启动时检测到RDB文件的存在,它就会自动载入RDB文件.


因为AOF文件的更新频率比RDB文件更新频率高:

- 如果服务器开启了AOF持久化功能,那么服务器会优先使用AOF文件还原数据库状态

- 只有在AOF持久化功能处于关闭状态时,服务器才会使用RDB文件来还原数据库状态.



** 服务器在载入RDB文件期间,会一直处于阻塞状态,直到载入工作完成为止**


### 自动间隔性保存

redis允许用户通过设置服务器哦诶之的save选项,让服务器每隔一段时间就自动执行一次BGSAVE命令.用户可以通过save选项设置多个保存条件,但只要其中任意一个条件满足,服务器就会执行BGSAVE命令:

例如.如果我们提供以下选项:

```
save 900 1

save 300 10

save 60 10000

```

那么只要满足以下条件中的任意一个,BGSAVE命令就会被执行:

- 服务器在900秒之内,对数据进行了至少一次修改

- 服务器在300秒内,对数据库进行了至少10次修改

- 服务器在60内,对数据库至少进行了10000次修改


### 设置保存条件

