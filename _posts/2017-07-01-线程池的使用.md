---
layout: post
title:  "线程池的使用"
date:   2017-07-01 00:06:05
categories: 技术
tags: 学习
excerpt: 线程池的使用
---


* content
{:toc}

###  ThreadLocal

背景：ThreadLocal是java语言提供的用于支持线程局部变量的标准实现类。它通过避免对象的共享，达到线程安全的目的。

虽然是通过ThreadLocal来设置特定于各个线程的数据资源，但ThreadLocal自身不会保存这些特定的数据资源。因为数据资源特定于线程，自然是由每个线程自己来管理了。每个Thread类都有一个ThreadLocal.ThreadLocalMap的实例变量，它就是保持那些通过ThreadLocal设置给这个线程的数据资源的地方。当通过Threadlocal的Set(data)方法设置数据的时候，ThreadLocal会首先获取当前线程的引用，然后通过该引用获取当前线程持有的threadLocals,最后，以当前ThreadLocal作为Key,将要设置的数据设置到当前线程，如下：

```
Thread thread = Thread.currentThrad();

ThreadLocalMap threadlocalmap = thread.threadLocals;
...
threadlocamap.set(this,obj);

```
余下的get()之类的方法：首先取得当前线程，然后根据每个方法的语义，也可以通过这个窗口获取绑定数据资源，当然，更可以解除之前绑定到当前线程的数据资源。在整个线程的生命周期内，我们都可以通过ThreadLocal这个窗口与当前线程大交道。

![image](http://7xpuj1.com1.z0.glb.clouddn.com/Threadlocal.png)

####  ThreadLocal的应用场景

 - 横向看，我们更注重于ThreadLocal横跨多个线程的能力，这是ThreadLocal最初的目的所在。为了以更加简单地方式来管理应用程序的线程安全，ThreadLocal干脆将没有必要共享的对象不共享，直接为每个线程分配一份各自特定的数据资源。

- 纵向看，我们则着眼于ThreadLocal在单一线程内可以发挥的能力，通过ThradLocal设置的特定于各个线程的数据资源，可以随着所在的线程执行流程“随波逐流”


---

管理应用程序实现中的线程安全：对于某些有状态或者非线程安全的对象，我们可以再多线程程序中为每个线程都分配相应的副本，而不是让多个线程共享该类型的某个对象，从而避免了需要协调多个线程对这些对象进行访问的“危险”工作。

在JDBC中，Connection对象属于有状态并且非线程安全的类。为了保证多个线程使用Connection进行数据访问过程中的安全，我们通过ThreadLocal为每个线程分配了一个他们各自持有的Connection,从而避免了对单一Connection资源的竞争。毕竟，在JDBC中是一个Connection对应一个事务。如果所有线程都公用一个Connection，事务管理就失控了。
