---

layout: post
title:  "spring源码学习"
date:   2017-06-10 00:06:05
categories: 技术
tags: spring
excerpt:spring源码学习

---


* content
{:toc}

---


## IOC 基本原理和思想

整片文章以如下业务为例：

![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E6%B5%8B%E8%AF%95%E7%B1%BB.png)


### ioc 基本概念

定义：全称是Inversion of control, 中文翻译为“控制反转”，别名叫做依赖注入(dependency Injection)

通常情况下，被注入对象会直接依赖于被依赖的对象。（我们常见的直接构造一个对象过来）。但是在IOC 场景中，二者是通过 Ioc Service Provider 来打交道，所有被注入对象和依赖对象现在有其统一管理。Ioc  Service Provider 在这里充当的就是通常说的IOC 容器角色。

---

![image](http://7xpuj1.com1.z0.glb.clouddn.com/ioc.png)

从被注入对象的角度看，与之前直接寻求依赖对象相比，依赖对象方式发生了反转，控制也从被注入对象转到了IOC service provider 哪里。

---

![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E5%BD%A2%E8%B1%A1%E5%9B%BE.png)

被注入对象通知ioc service provider 提供具体服务的方式：

- 构造注入法
  被注入对象可以通过其在构造方法中申明依赖对象的参数列表，让外部（通常是ioc容器）知道他需要依赖那些对象。
  ioc service provider 会检查被注入对象的构造方法，取得他需要的依赖对象列表，进而为其注入相应的对象。
  **优点**:对象构造完成之后就进入就绪状态，可以立马使用。但构造方法无法继续，对非必须参数处理不够灵活。
- setter注入法
  当前对象只要为其依赖对象所对应的属性添加setter 方法，就可以通过setter方法将对应的依赖对象设置到被注入对象中。
  相对灵活，可以不像构造注入那样，可以在对象先构造完成再注入。
  ** 优点**：setter方法可以被继承，允许设置默认值。
- 接口注入
  被注入对象想要IOC Service Provider 为其注入依赖对象， 就必须实现某个接口。这个接口提供一个方法，用来为其注入依赖对象。

### 总结：Ioc是一种可以帮助我们解耦各个业务对象间依赖关系的对象绑定方式。


### IOC Service Provider 基本原理

#### ioc Service Provider的基本职责

- 业务对象的构建管理。IOC 中，业务对象无需关心所依赖对象如何构建如何取得，这部分工作被IOC Service Provider 从客户端对象哪里剥离出来，以免这部分逻辑污染业务对象的实现。

- 业务对象间的依赖绑定。IOC Service Provider 通过结合之前构建和管理的所有业务对象，以及各个业务对象间可以识别的依赖关系，将这些对象所依赖的对象注入绑定，从而保证每个业务对象在使用的时候，可以处于就绪状态。

#### ioc Service Provider工作方式

- 直接编码方式
  在容器启动之前，我们就可以通过程序编码的方式将被注入对象和依赖对象注册到容器当中，并明确确认他们相互之间的依赖注入关系。
  
  ```
   IoContainer container = ...;
   container.register(FxNewsProvider.class,new FxNewProvider());
   container.register(IFxNewsListener.class,new FxNewListener());
   ...
   
   FxNewsProvider newsProvider = (FxNewsProvider)container.get(FxNewsProvider.class);
   newsProvider.getAndPersistNews();

  ```
- 配置文件方式
  普通文件，properties文件，xml文件等都可以成为管理依赖注入关系的载体。最常见的还是通过xml管理对象注册和对象间依赖关系。

```
 <bean id ="newsProvider" class="..FxNewsProvider">
      <property name="newsListener">
         <ref bean="djNewListener"/>
      </property>
      <property name="newsPersistener">
         <ref bean="djNewPersistener"/>
      </property>
 </bean>
  <bean id ="djNewListener" class="..impl.DowJonesNewsListener">
 </bean>
   <bean id ="newsPersistener" class="..impl.DowJonesNewsPersistener">
 </bean>

```
读取对象：

```
container.readConfigurationFiles(...);
FxNewsProvider newsProvider = (FxNewsProvider)container.get(FxNewsProvider.class);
newsProvider.getAndPersistNews();

```

- 元数据方式

我们可以直接在类中使用元数据信息来标注各个对象之间的依赖关系，然后由Guice框架根据这些注解所提供的信息将这些对象组装后，交给客户端对象使用。

```
public class FXNewsProvider
{
    private IFXNewsListener newsListener;
    private IFXNewsPersister newPersistener;
    @Inject
    public FXNewsProvider(IFXNewsListener listener,IFXNewsPersister newPersistener)
    {
        this.newsListener = listener;
        this.newPersistener = persistener
    }
    
}

```
通过@Inject ,我们指明需要IOC Service Provider 通过构造方法注入方式，为FXNewsProvider 注入其所依赖的对象。至于余下的依赖相关信息，在guice中由响应的Module来提供。
FXNewsProvider 所使用的Module实现
```
public class NewsBindingModule extends AbstractModule{
    @Override
    protected void configure(){
        bind(IFXNewsListener.class)
        .to(DowJonesNewsListener.class).in(Scopes.SINGLETON);
        bind(IFXNewsListener.class)
        .to(DowJonesNewsPersistener.class).in(Scopes.SINGLETON);
    }
}
```

从guice获取并使用最终绑定完成的FXNewsProvider

```
Injector injector = Guice.createInjector(new NewsBindingModule());
FXNewsProvider newsProvider = injector.getInstance(FXNewsProvider.class);
newsProvider.getAndPersistNews();

```

#### spring提供了两种容器类型
- [ beanFactory]  基础类型ioc  容器，提供完整ioc服务支持。默认采用延迟初始化策略（lazy-load）只有当客户端对象需要访问容器中的某个受管对象的时候，才对该受管对象进行初始化以及依赖注入操作。
- [application ]  在beanFactory的基础上构建，是相对比较高的容器实现，除了拥有beanfactory的所有支持，还提供了其他高级功能。applicationContext所管理的对象，在容器启动之后，默认全部初始化，容器启动时间较BeanFactory长一些。

#### spring的IOC 容器之 BeanFactory

![image](http://7xpuj1.com1.z0.glb.clouddn.com/springIOC%E5%AE%B9%E5%99%A8.png)
分为两部分理解：IOC 和容器（ioc 指的是ioc service provider 功能）此外还包括的功能aop,s生命周期管理等。


beanFactory的定义
![image](http://7xpuj1.com1.z0.glb.clouddn.com/beanfactory%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89.png)









----

学习内容来源于王福强先生的《Spring 揭秘》
更新中。。。
