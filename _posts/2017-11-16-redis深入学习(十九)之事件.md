---
layout: post
title:  "redis深入学习(十九)之事件"
date:   2017-09-22 01:06:05
categories: noSQL
tags: redis
excerpt: redis
---


* content
{:toc}


### 事件

redis服务器时一个事件驱动程序,服务器需要处理一下两类事件:

- 文件事件:Redis服务器通过套接字与客户端或者其他Redis服务器进行连接,而文件事件就是服务器对套接字操作的抽象.服务器与客户端的通信会产生相应的文件事件,而服务器则通过监听并处理这些事件来完成一些列网络通信操作.

- 时间事件:Redis服务器中的一些操作(比如serverCron函数)需要在给定的时间点执行,而时间事件就是服务器对这类定时操作的抽象.

### 文件事件

Redis基于Reactor模式开发了自己的网络事件处理器:这个处理器被称为文件事件处理器:

- 文件事件处理器使用I/O多路复用程序来同时监听多个套接字,并且根据套接字目前执行的任务来为套接字关联不同的事件处理器.

- 当被监听的套接字准备好执行来执行连接应答(accept),读取(read),写入(write),关闭(close)等操作时,与操作相对应的文件事件就会产生,这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件.

虽然文件事件处理器以单线程方式运行,但通过使用IO复用程序来监听多个套接字,文件事件处理器既实现了高性能网络通信模型,又可以很好地与redis服务器中其他同样以单线程方式运行的模块进行对接,这保持了redis内部单线程设计的简单性.


#### 文件事件处理器构成



![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%E6%9E%84%E6%88%90.png)

尽管多个文件事件可能会并发地出现,但IO多路复用程序总是会将所有产生事件的套接字都放到一个队列里,然后通过这个队列,以有序(sequentially),同步(synchronously)每次一个套接字的方式向文件事件分派器传送套接字.当上一个套接字产生的事件被处理完成之后(该套接字为事件所关联的事件处理器执行完毕),IO多路复用程序才会继续向文件分派器传送下一个套接字.

![image](http://7xpuj1.com1.z0.glb.clouddn.com/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%A8%8B%E5%BA%8F%E9%80%9A%E8%BF%87%E9%98%9F%E5%88%97%E5%90%91%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%88%86%E6%B4%BE%E5%99%A8%E4%BC%A0%E9%80%81%E5%A5%97%E6%8E%A5%E5%AD%97.png)

文件事件分派器接收IO多路复用程序传来的套接字,并根据套接字产生的事件类型,调用相应的事件处理器.服务器会为执行不同任务的套接字关联不同的事件处理器,这些处理器是一个个函数,它们定义了某个事件发生时,服务器应该执行的动作.

#### 多路复用程序的实现

redis的IO多路复用程序的所有功能都是通过包装常见的select,epoll,evport和kqueue这些IO多路复用函数库来实现的,每个IO多路复用函数库在redis源码中都对应一个单独的文件

因为redis为每个IO多路复用函数都实现了相同的API,所以IO多路复用程序的底层实现是可以互换的.


#### 事件的类型

IO多路复用程序可以监听多个套接字的ae.h/AE_READABLE事件和ae.h/AE_WRITABLE事件,这两类事件和套接字操作之间的对应关系如下:

- 当套接字变得可读时(客户端对套接字执行write操作,或者执行close操作)或者有新的可应答(acceptable)套接字出现时(客户端对服务器的监听套接字执行connect操作),套接字产生AE_READABLE事件.
- 当套接字变得可写时(客户端对套接字执行read操作),套接字产生AE_WRITABLE事件.

如果一个套接字又可读又可写的时候,服务器将先读套接字然后写套接字.

### 时间事件

redis的时间可以分为以下两类:
- 定时事件:让一段程序在指定的时间之后执行一次,
- 周期性事件:让程序每隔一段时间就执行一次.

一个时间事件主要由以下三个属性组成:

- id: 服务器为时间事件创建的全局唯一ID.ID号从小到大的顺序递增,新事件的ID号比旧事件的ID号要大
- when:毫秒精度的UNIX时间戳,记录了时间事件的到达时间
- timeProc:时间事件处理器,一个函数.当时间到达时,服务器会调用相应的处理器来处理事件.

一个时间事件是定时事件还是周期性事件取决于事件事件处理器的返回值:

- 如果事件处理器返回ae.h/AE_NOMORE,那么这个事件为定时事件:该事件在到达一次之后就会被删除,之后不再到达
- 如果返回一个整数值,那么这个事件为周期性时间:当一个时间事件到达之后,服务器会根据处理器返回的值,对时间事件的when属性进行更新,让这个事件在一段时间之后再次到达,并以这种方式一直更新并允许下去.

#### 实现

服务器将所有时间事件都放在一个无序链表中,每当事件事件执行器运行时,它就遍历整个链表,查找所有已到达的时间事件,并调用事件处理器.

![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E5%AE%9E%E7%8E%B0.png)

