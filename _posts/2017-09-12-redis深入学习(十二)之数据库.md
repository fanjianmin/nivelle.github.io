---
layout: post
title:  "redis深入学习(十二)之数据库"
date:   2017-09-09 01:06:05
categories: noSQL
tags: redis
excerpt: redis
---


* conten

### 数据库

#### 服务器中的数据库

redis服务器将所有数据库都保存在服务器状态redis.h/redisServer结构的db数组中,db数组的每个项都是一个redis.h/redisDb结构,每个redisDb结构代表一个数据库:

```

struct redisServer{
  //...
  //一个数组,保存着服务器中的所有数据库
  redisDb *db;
  //服务器的数据库数量
  int dbnum;
};


```

初始化服务器时,程序会根据服务器状态的dbnum属性来决定应该创建多少个数据库:



dbnum属性的值由服务器配置的database选项决定,默认情况下,该选项的值为多少,redis服务器默认会创建几个数据库;

![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A4%BA%E4%BE%8B.png)

#### 切换数据库

每个redis客户端都有自己的目标数据库,每当客户端执行数据库写命令或数据库读命令的时候,目标数据库就会成为这些命令的操作对象.


默认情况下,redis客户端的目标数据库为0号数据库,但客户端可以通过执行select命令来切换数据库.

```

redis > SET msg "hello world"
OK

redis > GET msg
"hello world"

redis > select 2
OK

redis[2] > GET msg
(nil)

redis[2]> SET msg "another world"
ok

redis[2]>GET msg
"another world"


```

在服务器内部,客户端状态redisClient结构的db属性记录了客户端当前的目标数据库,

```
typedef struct redisClient{
  //...
  //记录客户端当前正在使用的数据库

  redisDb *db;

}redisClient;


```

#### 数据库键空间

redis是一个键值对数据库服务器,服务器中的每个数据库都由一个redis.h/redisDb结构表示,其中redisDb结构的dict字典保存了数据库中的所有键值对,我们将这个字典称为键空间:

```
typedef struct redisDb{
  //...
  //数据库键空间,保存着数据库中所有键值对
  dict *dict;
}redisDb;


```

** 键空间和用户所见的数据库是直接对应的:**

- 键空间的键也就是数据库的键,每个键都是一个字符串对象

- 键空间的值也就是数据库的值,每个值可以是字符串对象,列表对象,哈希表对象,集合对象和有序集合对象中的任意一种redis对象

![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%AE%E7%A9%BA%E9%97%B4%E4%BE%8B%E5%AD%90.png)

因为数据库的键空间是一个字典,所以所有针对数据库的操作,比如添加一个键值对到数据库,或者从数据库中删除一个键值对,又或者在数据库中获取某个键值对等,实际上都是通过对键空间字典进行操作来实现.

#### 添加新建

添加一个新键值对到数据库,实际上就是将一个新键值对添加到键空间字典里面,其中键为字符串对象,而值则为任意一种类型的redis对象.

#### 删除键

删除数据库中的一个键,实际上就是在键空间里面删除键所对应的键值对对象.

#### 更新键

对一个数据库键进行更新,实际上就是对键空间里面键对应的值对象进行更新,根据值对象类型不同,更新的具体方法也会有所不同

#### 对键取值

对一个数据库键进行取值,实际上就是在键空间中取出键所对应的值对象,根据值对象的类型不同,具体的取值方法也不同.

### 读写键空间时的维护操作

当使用redis命令对数据库进行读写时,服务器不仅会对键空间执行指定的读写操作,还会执行一些额外的维护操作:

- 在读取一个键后(读操作和写操作都要对键进行读取),服务器会根据键是否存在来更新服务器的键空间命中(hit)次数货键空间不命中(misss)次数,这两个值可以在INFO stats命令的keyspace_hits属性和keyspace_misses属性中查看

- 在读取一个键之后,服务器会更新键的LRU(最后一次使用)时间,这个值可以用于计算键的闲置时间,使用OBJECT idletime<key>命令可以查看键key的闲置时间

- 如果服务器在读取一个键时发现该键已经过期,那么服务器会先删除这个过期键,然后才执行余下的其他操作

- 如果客户端使用WATCH命令监视了某个键,那么服务器在对被监视的键进行修改之后,会将这个键标记为脏(dirty),从而让事务程序注意到这个键已经被修改过

- 服务器每次修改一个键之后,都会对脏(dirty)键计数器的值增1,这个计数器会触发服务器的持久化以及复制操作.

- 如果服务器开启了数据库通知功能,那么在对键进行修改之后,服务器将按配置发送响应的数据库通知.

## 设置键的生存时间或过期时间

通过EXPIRE命令或者PEXPIRE命令,客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间(Time To Live,TTL),在经过指定的秒数或者毫秒数胡,服务器会自动删除生存时间为0的键:

```

redis > set key value
ok

redis > EXPIRE key 5
(integer)1

redis > GET key//5秒之内
"value"

redis > GET key //5秒之后
(nil)


```
[redis设计与实现](https://book.douban.com/subject/25900156/) 作者:黄健红
