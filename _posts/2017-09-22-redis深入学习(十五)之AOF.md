---
layout: post
title:  "redis深入学习(十五)之AOF"
date:   2017-09-22 01:06:05
categories: noSQL
tags: redis
excerpt: redis
---


* conten


## AOF持久化

aof 持久化是通过保存redis服务器所执行的写命令来记录数据库状态的


![image](http://7xpuj1.com1.z0.glb.clouddn.com/aof%E6%8C%81%E4%B9%85%E5%8C%96.png)


rdb持久化保存数据库状态的方法是将键值对保存到RDB文件中,而AOF持久化保存数据库状态的方法是将服务器执行的命令保存到文件中.

被写入AOF文件的所有命令都是以redis的命令请求协议格式保存的,因为redis命令请求协议是纯文本格式,所以我们可以直接打开一个AOF文件,观察里面的内容.

服务器在启动时,可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的数据库状态,以下就是服务器载入AOF文件并还原数据库状态时打印的日志.

#### AOF持久化的实现

AOF持久化功能的实现可分为命令追加(append),文件写入,文件同步(sync)三个步骤.

- 命令追加

当AOF持久化功能处于打开状态时,服务器在执行完一个写命令后,会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓冲区的末尾:


```

struct redisServer{
	//AOF缓冲区

	sds aof_buf;
};


```

- AOF文件的写入与同步

Redis的服务器进程就是一个事件循环,这个循环中的文件事件负责接收客户端的命令请求,以及向客户端发送命令回复,而时间事件则负责执行像serverCron函数这样需要定时运行的函数.

因为服务器在处理文件事件时可能会执行写命令,使得一些内容被追加到aof_buf缓冲区里面,所以在服务器每次结束一个事件循环之前,它都会调用flushAppendOnlyFile函数,考虑是否需要将aof_buf缓冲区中的内容写入和保存到AOF文件里面:


```
def eventLoop():

 while true:

 //处理文件事件,接收,命令请求以及发送命令回复
 //处理命令请求时可能会有新内容追缴到aof_buf缓冲区中

 processFileEvents()

 //处理时间事件
 processTimeEvents()


 //考虑是否将aof_buf中的内容写入和保存到AOF文件里面
 flushAppendOnlyFile()


```

flushAppendOnlyFile函数的行为有服务器配置的appendfsync选项的值来决定,各个不同值产生的行为如下:

appendfsync选项的值 | flushAppendOnlyFile函数的行为

--- | --- 

always | 将aof_buf缓冲区中的所有内容写入并同步到AOF文件
everysec | 将aof_buf缓冲区中的所有内容写入到AOF文件,如果上次同步AOF文件的时间距离现在超过一秒钟,那么在此对AOF文件进行同步时,并且这个同步操作时又一个线程专门负责执行
no | 将aof_buf缓冲区中的所有内容写入到AOF文件,但并不对AOF文件进行同步,何时同步由操作系统来决定


** 默认为everysec **


### AOF文件的载入与数据还原

aof文件包含了重建数据库状态所需的所有写命令,所以服务器只要读入并重新执行一遍AOF文件里面保存的写命令,就可以还原服务器关闭之前的数据库状态.

Redis读取AOF文件并还原数据库状态的详细步骤如下:

- 创建一个不带网络连接额伪客户端:因为Redis的命名了只能在客户端上下文中执行,而载入AOF文件时所使用的命令直接来源于aof文件而不是网络连接,所以服务器使用一个没有网络连接的伪客户端来执行AOF文件保存的写命令,伪客户端执行命令效果和带网络客户端执行命令的效果完全一样.

- 从aof文件中分析并读取出一条写命令

-使用伪客户端执行被读出的写命令

- 一直执行步骤2和步骤3,直到AOF文件中所有写命令都被处理完毕为止


![image](http://7xpuj1.com1.z0.glb.clouddn.com/aof%E5%86%99%E5%85%A5%E8%BF%87%E7%A8%8B.png)

### AOF重写

虽然Redis将生成新的AOF文件替换旧AOF文件的功能命名为'AOF文件重写',但实际上,AOF文件重写并不需要对现有的AOF文件进行任何读取,分析或者写入操作,这个功能时通过读取服务器当前的数据库状态来实现的.

为了解决AOF文件体积膨胀的问题,redis提供了AOF文件重写功能,通过该功能,redis服务器可以创建一个新的AOF文件来替代现有的AOF文件,新旧两个AOF文件保存的数据库状态相同,但新的AOF文件不会包含任何良妃空间冗余命令,所以新的Aof文件体积通常会比旧的AOF文件体积小的多.


![image](http://7xpuj1.com1.z0.glb.clouddn.com/aof%E9%87%8D%E7%82%B9.png)
