---
layout: post
title:  "Zookeper学习(二)"
date:   2016-04-12 01:06:05
categories: 技术
tags: zk
excerpt: zk
---


* content
{:toc}

### Zookeeper介绍

Zk为分布式应用提供了高效且可靠的分布式协调服务，提供了诸如统一命名服务、配置管理和分布式锁等分布式的基础服务。在解决分布式数据一致性方面，Zk并没有直接采用Paxos算法，而是采用了一种被称为ZAB的一致性协议。ZK是一个典型的分布式数据一致性的解决方案，分布式应用程序可以基于它实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master选举、分布式锁和分布式队列等功能。zk保证如下分布式一致性特性。

- 顺序一致性

从同一个客户端发起的事务请求，最终将会严格地按照其发起顺序被应用到zk中去。

- 原子性

所有事务请求的处理结果在整个集群中所有机器上的应用情况是一致的，要么真个集群所有机器都成功应用了某一个事务，要么都没有应用，一定不会出现集群部分机器应用了该事务，而另外一部分没有应用的情况。

- 单一视图

无论客户端连接的是哪个Zk服务器，其看到的服务端数据模型都是一致的。

- 可靠性

一旦服务端成功地应用了一个事务，并完成对客户端的响应，那么该事务所引起服务端状态变更将会被一直保留下来，除非有另一个事务又对其进行了变更。

- 实时性

通常人们看到实时性的第一反应是，一旦一个事务被成功应用，那么客户端能够立即从服务端上读取到这个事务变更后的最新数据状态。

### Zookeeper的设计目标

致力于提供一个高性能、高可用，且有严格的顺序访问控制能力的分布式协调服务。

#### 目标一：简单数据模型

zk使得分布式程序能够同过一个共享的、树型结构的名字空间来进行相互协调。树型结构的名字空间：是指zk服务器内存中的一个数据模型，其由一系列被称为ZNode的数据节点组成，总的来说，其数据模型类似于一个文件系统，而ZNode之间的层级关系，就像文件系统的目录结构一样。不过和传统的磁盘文件系统不同的是，zk将全量数据存储在内存中，以此来实现提高服务器吞吐、减少延迟的目的。

#### 目标二：可以构建集群

一个Zk集群通常由一组机器组成，一般3~5台机器就可以组成一个可用的zk集群了。

![image](http://7xpuj1.com1.z0.glb.clouddn.com/zk%E9%9B%86%E7%BE%A4.png)

组成zk集群的每台机器都会在内存中维护当前的服务器状态，并且每台机器之间都互相保持着通信。值得一提的是，只要集群中存在超过一半的机器能够正常工作，那么整个集群就能够正常对外服务。

Zk的客户端程序会选择和集群中任意一台机器来共同来创建一个TCP连接，而一旦客户端和某台Zk服务器之间的连接断开后，客户端会自动连接到集群中的其他机器。

#### 目标三：顺序访问

对于来自客户端的每个更新请求，zk都会分配一个全局唯一的递增编号，这个编号反映了所有事务操作的先后顺序，应用程序可以使用zk的这个特性来实现更高层次的同步原语。

#### 目标四：高性能

由于zk将全量数据存储在内存中，并直接服务于客户端的所有非事务请求，因此它尤其适用于以读操作作为主的应用场景。

---

###  ZooKeeper的基本概念

集群角色：Leader、Follower和Observer三种角色。Zk集群中的所有机器通过一个Leader选举过程来选定一台被称为“Leader”的机器，Leader服务器为客户端提供读和写服务。除Leader外，其他机器包括Follower和Observer。Follower和Observer都能够提供读服务，唯一区别在于，Observer机器不参与Leader选举过程，也不参与写操作的“过半写成功”策略。因此Observer可以在不影响写性能的情况下提升集群的读性能。

#### 会话(Session)

Session是指客户端会话。在Zk中，一个客户端连接是指客户端和服务器之间的一个TCP长连接。zk对外的服务器端默认是2181，客户端启动的时候，首先会与服务器建立一个TCP连接，从第一次建立连接开始，客户端会话的生命周期也开始了，通过这个连接，客户端能够通过心跳检测与服务器保持有效的会话，也能够向zk服务器发送请求并接受响应，同时还能通过该连接，接收来自服务器的Watch事件通知。

Session的sessionTimeout值用来设置一个客户端会话的超时时间，由于服务器压力大、网络故障或是客户端主动断开连接等各种原因导致客户端连接断开时，只要在sessionTimeout规定的时间内能够重新连接上集群中任意一台服务器，那么之前创建的会话任然有效。

#### 数据节点(Znode)

分布式中，通常说的节点指组成集群的每一台机器。然而，在ZK中，节点分为两类。第一类同样是指构成集群的机器，我们称为机器节点；第二类则是指数据模型中的数据单元，我们称之为数据节点————ZNode。zk将所有数据存储存储在内存中，数据模型是一棵树(ZNode Tree),由斜杠(/)进行分割的路径，就是一个ZNode，例如/foo/path1。每个ZNode 上都会保存自己的数据内容，同时还会保存一些列属性信息。

在Zk中，ZNode可以分为持久节点和临时节点两类。持久节点是指一旦这个ZNode被创建了，除非主动进行ZNode的移除操作，否则这个ZNode将一直保存在ZK上。而临时节点，它的生命周期和客户端会话绑定，一旦客户端会话失效，那么这个客户端创建的所有临时节点都被移除。

#### 版本

zk的每个ZNode上都会存储数据，对应于每个ZNode，zk都会为其维护一个叫做Stat的数据结构，Stat中记录了这个ZNode的三个数据版本，分别是version(当前ZNode的版本)、cversion(当前ZNode子节点的版本)和aversion(当前ZNode的ACL版本)

#### Watcher

Watcher(事件监听器)，zk允许用户在指定节点上注册一些Watcher，并且在一些特定事件触发的时候，zk服务端会将事件通知到感兴趣的客户端上去，该机制使zk实现分布式协调服务的重要特性。

#### ACL

zk采用ACL(Access Control Lists)策略来进行权限控制，类似于UNIX文件系统的权限控制。zk定义了如下五种权限：

- CREATE:创建子节点的权限。
- READ:获取节点数据和子节点列表的权限。
- WRITE:更新节点数据的权限。
- DELETE:删除子节点的权限。
- ADMIN:设置节点ACL的权限。

---

### ZAB协议(原子广播协议)

**核心：ZAB协议是为分布式协调服务zk专门设计的一种支持崩溃恢复的原子广播协议。**

在Zk中，主要依赖ZAB协议来实现分布式数据一致性，基于该协议，zk实现了一种主备模式的系统架构来保持集群中各副本之间数据的一致性。具体的，zk使用一个单一的主进程来接收并处理客户端的所有事务请求，并采用ZAB的原子广播协议，将服务器数据的状态变更以事务Proposal的形式广播到所有的副本进程上去。ZAB协议这个主备模型架构保证了同一时刻集群中只能够有一个主进程来广播服务器的状态变更，因此能够很好地处理客户端大量的并发请求。另一方面考虑到在分布式环境中，顺序执行的一些状态变更其前后会存在一定的依赖关系，有些状态变更必须依赖于比它早生成的那些状态变更。**ZAB协议需要保证如果一个状态变更已经被处理了，那么所有其依赖的状态变更都应该已经被提前处理掉了。**，同时考虑到主进程在任何时候都有可能出现崩溃退出或重启现象，因此，ZAB协议还需要做到在当前主进程出现上述异常情况的时候，依旧能正常工作。


![image](http://7xpuj1.com1.z0.glb.clouddn.com/ZK%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86.png)
