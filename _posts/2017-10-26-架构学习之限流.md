---
layout: post
title:  "限流"
date:   2017-10-25 00:06:05
categories: 架构
tags: 架构
excerpt: 限流
author: nivelle
---

* content
{:toc}

### 限流

背景:高并发系统中,有很多手段来保护系统,如缓存,降级和限流.缓存的目的是提升系统访问速度和增大系统处理能力,可谓抗高并发流量的银弹.而降级是当服务出问题或者影响到核心流程的性能,需要暂时屏蔽掉,待高峰过去或者问题解决后再打开的场景.而有些场景并不能用缓存和降级来解决,比如稀缺资源(秒杀,抢购),写服务(评论,下单),频繁的复杂查询(评论的最后几页)等.需要限流手段来处理.


限流的目的是通过对并发访问/请求进行限速或者一个时间窗口内的请求进行限速来保护系统,一旦达到限制则可以拒绝服务(定向到错误页或者告知资源没有了),排队或者等待(比如秒杀,评论,下单),降级(返回兜底数据或者默认数据,如商品详情页或者库存默认有货)


* 限流种类:*

- 限制总并发数(数据库连接池,线程池)

- 限制瞬时并发数(如Nginx的limit_conn模块,用来限制瞬时并发连接数)

- 限制时间窗口内的平均速率(如Guava的RateLimiter,Nginx的limit_req模块用来限制每秒的平均速率),以及限制远程接口调用速率,限制MQ的消费速率等还可以根据网络连接数,网络流量,CPU或内存负载来限流


#### 限流算法

- 令牌桶算法

令牌桶算法,是一个存放固定容量令牌的桶,按照固定速率往桶里添加令牌.

描述:

1.假设限制2r/s,则按照500毫秒的固定速率往桶中添加令牌

2. 桶中最多存放b个令牌,当桶满时,新添加的令牌被丢弃或拒绝

3. 当一个n个字节大小的数据包到达,将从桶中删除N个令牌,接着数据包被发送到网络上

4. 如果桶中的令牌不足n个,则不会删除令牌,且数据包将被限流(要么丢弃,要么在缓冲区等待.)

![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95.png)

- 漏桶算法

漏桶作为计量工具时,可以用于流量整形和流量控制.

描述:

1. 一个固定容量的漏桶,按照常量固定速率流出水滴

2. 如果桶是空的,则不需流出水滴

3. 可以以任意速率流入水滴到漏桶

4. 如果流入水滴超出了桶的容量,则流入的水滴溢出了(被丢弃),而漏桶容量是不变的


![image](http://7xpuj1.com1.z0.glb.clouddn.com/%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95.png)


比较:

- 令牌桶是按照固定速率往桶中添加令牌,请求是否被处理需要看桶中令牌是否足够,当令牌数减为零时,则拒绝新的请求

- 漏桶则是按照常量固定速率流出请求,流入请求速率任意,当流入的请求数累积到罗通容量时,则新流入的请求被拒绝

- 令牌桶限制的是平均流入速率(允许突发请求,只要有令牌就可以,支持一次拿几个令牌),并允许一定程度的突发流量

- 漏桶限制的是常量流出速率(流出速率是一个固定常量值,比如都是1的速流出,而不能是1,下次是2),从而平滑突发流入速率

- 令牌桶允许一定程度的突发,而漏桶主要目的是平滑流入速率

- 两个算法实现可以一样,但是方向相反,对于相同的参数得到的限流效果一样.


还可以使用计数器来进行限流,主要是用来限制并发数,比如数据库连接池大小,线程池大小,秒杀并发数都是计数器的用法.只要全局总请求数或者一定时间段的总请求数达到设定阈值,则进行限流.简单粗暴.


### 应用级限流
